---
title: "Tidytuesday_UN_votes"
author: "FG"
date: "3/22/2021"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r library, message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(scales)
library(DT)
library(unvotes)
library(tidytuesdayR)
#############################################

```


Set the colors
```{r}
palette <- c("ocra" = "#F7BB0B", 
             "lilla" = "#C88BD9", 
             "turchese" = "#49B3BF", 
             "verdino" = "#94BF75", 
             "strong_orange" = "#FD5403", 
             "antracite" = "#2e2e2e")


title_clr <- "#94BCFF" #celestino


bck_clr <- "grey20"


#bck_color <- "#FEFCEF" #panna
```



Get the Data
```{r message=FALSE, warning=FALSE}
unvotes <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-03-23/unvotes.csv')
roll_calls <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-03-23/roll_calls.csv')
issues <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-03-23/issues.csv')
```




Merge the sets by "rcid" reference component id
```{r}
unvotes_full <- unvotes %>%
 inner_join(un_roll_calls, by = "rcid") %>%
 inner_join(un_roll_call_issues, by = "rcid")


head(unvotes_full,3)
```

```{r}
hr<-unvotes_full%>%filter(short %in% "DECLARATION OF HUMAN RIGHTS")
glimpse(hr)
```


# 'ALL PEOPLES SHALL HAVE THE RIGHT OF SELF-DETERMINATION...'

```{r}
with(hr,(table(descr)))

Declaration_of_HR<-c("AMENDMENT TO RES B (A/9249)",
  "CUBAN PROPOSAL (A/3-C)",
  "AUSTRALIA AMENDMENT (A/L.181)",
  "CHILE AMENDMENT (A/2115)",
  "OPERATIVE PARAGRAPH 1 (A/2112)",
  "USSR AMENDMENT (A/1576)")

n_countries<-c(123,49,59,58,118,58)

tab<-as.data.frame(cbind(Declaration_of_HR,n_countries))

tab$n_countries<-as.numeric(tab$n_countries)
glimpse(tab)

tab<-tab%>%arrange(n_countries)
```


```{r}
new_tab<-with(hr,table(year(date),descr))
glimpse(new_tab)

new_tab<-as.data.frame(new_tab)
new_tab<-new_tab%>%filter(Freq!=0)

new_tab<-new_tab%>%mutate(Year=Var1)


annotation_tab<-cbind(Year=new_tab$Year,tab)
```



```{r}
# ?table
descr <-with(hr,table(country,year(date),descr))
```


Select columns of interest
```{r}
unvotes_sub <- unvotes_full%>%
 select(date,country,session,vote,issue)
```



```{r}
german<-unvotes_full%>%filter(str_detect(country, "Germ"))
#table(german$country)
congo<-unvotes_full%>%filter(str_detect(country, "Congo"))
#table(congo$country)
yemen<-unvotes_full%>%filter(str_detect(country, "Yemen"))
#table(yemen$country)
guinea<-unvotes_full%>%filter(str_detect(country, "Guinea"))
#table(guinea$country)




unvotes_merged_country_names<-unvotes_sub%>%
mutate(country=case_when(country=="Federal Republic of Germany"~"Germany",
country=="German Democratic Republic"~"Germany",
country=="Congo - Brazzaville"~"Congo",
country=="Congo - Kinshasa"~"Congo",
country=="Micronesia (Federated States of)"~"Micronesia",
country=="Myanmar (Burma)"~"Myanmar",
country=="Yemen Arab Republic"~"Yemen",
country=="Yemen People's Republic"~"Yemen",
country=="Guinea-Bissau"~"Giunea",
TRUE~country))%>%
select(date,country,vote,issue) %>%
arrange(date)
```



library(sf)
library(raster)
library(spData)
library(spDataLarge)


World Map
```{r}


#un_continents<-

#world_un<-world[world$continent==un_continents]
```




```{r}
nuclear<-ggplot(data=subset(unvotes_sub,str_detect(issue,"Nuclear")))+
geom_bar(mapping=aes(x=vote,fill=vote))+
labs(title="Nuclear weapons and nuclear material all UN Countries")
```




```{r}
issues_plot<-ggplot() +
geom_bar(data=unvotes_sub,aes(x = vote,fill = issue,color=vote) )+
#scale_fill_hue() +
  theme(
    legend.position="NULL"
  )+
theme_minimal() +
facet_wrap(vars(issue))
```


check for missing values

```{r}

unvotes_new<-unvotes_full%>%
  arrange(desc(rcid),session)%>%
  mutate(year=year(date))%>%
  select(rcid,session,date,year,country,vote,issue)%>%
  mutate(vote = factor(vote,levels = c("no","abstain","yes")),
         vote = as.numeric(vote),
         rcid = paste0("rcid_",rcid))


# plyr::count(unvotes_new$session)

Y1946<-unvotes_new%>%
  filter(year=="1946")%>%
  select(rcid,session,country,vote,issue)%>%
  pivot_wider(names_from = "rcid",values_fn  = list("issue"))


Y1946%>%arrange(country)%>%filter(country %in% c("United States" , "Canada"))

# unvotes_full$descr[unvotes_full$rcid=="44"][1]
# summary(Y1946)


# pivot_wider(names_from = "rcid",values_from = "vote", values_fill = 2)




Y2019<-unvotes_new%>%
  filter(year=="2019")%>%
  select(rcid,country,vote,issue)%>%
  pivot_wider(names_from = "rcid",values_from = "vote")




a<-Y2019%>%arrange(country)%>%
  filter(country %in% c("United States" , "Canada"))%>%
  pivot_longer(col=rcid_9145:rcid_9139,)




```



```{r}
by_country_year <- unvotes_merged_country_names %>%
group_by(year = year(date), country) %>%
summarize(issue,votes = n(),
percent_yes = round(mean(vote == "yes")*100,1),
percent_no = round(mean(vote == "no")*100,1),
percent_astain = round(mean(vote == "abstain")*100,1))
```






```{r}
vote_yr<-unvotes_merged_country_names %>%
filter(country != c("Italy", "Haiti", "Mexico")) %>%
mutate(year = year(date)) %>%
group_by(country, year, issue) %>%
summarize(percent_yes = mean(vote == "yes"))%>%
filter(issue=="Human rights")

vote_yr_select_countries<-unvotes_merged_country_names %>%
filter(country %in% c("Italy", "Haiti", "Mexico")) %>%
mutate(year = year(date)) %>%
group_by(country, year, issue) %>%
summarize(percent_yes = mean(vote == "yes"))%>%
filter(issue=="Human rights")


linechart<- ggplot() +
geom_smooth(data=vote_yr,
mapping=aes(x = year, y = percent_yes,group=country),color="grey80",
size=0.3,method = "loess", se = FALSE)+

geom_smooth(data=vote_yr_select_countries,
mapping=aes(x = year, y = percent_yes,color=country),
size=0.8,method = "loess", se = FALSE)+
#facet_wrap(~issue)+


scale_y_continuous(labels = scales::percent)
#scale_x_continuous(label=seq(1946,2019,by=30))

linechart
```






scale_color_manual(values = palette) +
guides(color = FALSE)+
theme_void() +
theme(plot.background = element_rect(fill = bck_clr, color = NA),
panel.background = element_rect(fill = bck_clr, color = NA),
panel.spacing.x = unit(0, "lines"),
plot.margin = margin(0,0,0,0))




```{r}
main_plot<-ggplot(data=by_country_year)+
geom_line(aes(x=year,y=votes))


#scale_y_continuous(limits = c(-190000, 2000000)) +
#scale_x_continuous(expand = c(0.01,0.02)) +

percent_yes_plot<-ggplot(data=by_country_year,fill="issue")+
geom_point(aes(x=percent_yes,y=year))






main_plot
```


scale_color_manual(values = palette) +
guides(color = FALSE)+
theme_void() +
theme(plot.background = element_rect(fill = bck_clr, color = NA),
panel.background = element_rect(fill = bck_clr, color = NA),
panel.spacing.x = unit(0, "lines"),
plot.margin = margin(0,0,0,0))


palette <- c("ocra" = "#F7BB0B", 
             "lilla" = "#C88BD9", 
             "turchese" = "#49B3BF", 
             "verdino" = "#94BF75", 
             "strong_orange" = "#FD5403", 
             "antracite" = "#2e2e2e")


title_clr <- "#94BCFF" #celestino


bck_clr <- "grey20"


bck_color <- "#FEFCEF" #panna


```{r}
library(png)
library(ggpubr)

img <- png::readPNG("UN_image.png")

ggplot(data=by_country_year)+
  background_image(img)+
  geom_line(aes(x=year,y=votes),col="#2e2e2e")+

  
  
main_plot 
  

  
scale_color_manual(values = palette) +
guides(color = FALSE)+
theme_void() +
theme(
  plot.background = element_rect(fill ="#FEFCEF", color = NA),
  panel.background = element_rect(fill = "#FEFCEF", color = NA),
  panel.spacing.x = unit(0, "lines"),
  plot.margin = margin(0,0,0,0))


```


```{r}
img2="https://camo.githubusercontent.com/654fb54c78403255bbe1457b6a75423f5e370ee075eab4db0a189b886b68b8d7/68747470733a2f2f75706c6f61642e77696b696d656469612e6f72672f77696b6970656469612f636f6d6d6f6e732f7468756d622f652f65652f554e5f656d626c656d5f626c75652e7376672f3132303570782d554e5f656d626c656d5f626c75652e706e67"

g1<-ggbackground(main_plot, img2, alpha=.3, color="#94BCFF") + 
  ggtitle("Un Votes trend")
          
g2<-ggbackground(linechart, img2, alpha=.3,color="#94BCFF") + 
  ggtitle("Human rights: Three countries Yes propotion")

g3<-ggbackground(issues_plot, img2,alpha=.3,color="#94BCFF") + 
  ggtitle("Isuues UN votes results")

cowplot::plot_grid(g1, g2, g3, ncol=3)
```




```{r}
issue<-tibble(unique(unvotes_sub$issue))
issue[1,]
```








```{r}
issue_vote<-unvotes_sub %>%
group_by(year = year(date), country) %>%
summarize(issue,vote,votes = n())


```


```{r}


axis <- tibble(x = c(-1, -1, -1, -1),
xend = c(104, 104, 25, 25),
y = seq(0,1500000, 500000),
yend = seq(0,1500000, 500000)
)




xlabels <- tibble(x = seq(6,102,6),
y = rep(-40000, 17))




arrows <- tibble(x = c(18, -3, 51, 29, 87,100),
xend = c(12, 0.5, 56, 26, 91.5,120),
y = c(1780000, -140000, 820000, -180000, 720000,720000),
yend = c(1550000, 280000, 620000, -10000, 570000,570000),
curvature = c(-0.3, -0.4, -0.4, -0.4, 0.4,0.4),
issue_tb = c(issue[1,],
issue[2,],
issue[3,],
issue[4,],
issue[5,],
issue[6,]))




year_vote_plot<- ggplot(issue_vote) +
geom_bar(aes(x = issue,fill = vote)) +

xlab("")+ylab("")+

geom_text(data = axis,aes(x = x, y = y, label = scales::comma(y)),color = "red", size = 3.5,nudge_y = 30000, nudge_x = 1,family = "roboto condensed", hjust = 0)+


#geom_text(data = xlabels,aes(x = x, y = y, label = x),color = "white", size = 3.5,family = "roboto condensed", hjust = 0.5) +




labs(title = "UN votes on Issues from 1946 to 2019",
caption="inherited: Harvard Dataverse" )+ #,tag="TidyTuesday") +




scale_fill_hue() +


theme(plot.title = element_text(size = rel(1),face = "bold"),




legend.text = element_text(size = rel(1)),
legend.position="top",
legend.title = element_blank(),
legend.justification = "right",




axis.text = element_text(colour = "darkgrey"),
axis.text.x = element_blank(),
axis.text.y = element_blank(),
axis.ticks.y = element_line(size = 2),
# axis.text.y=element_text(label = scales::comma()),


panel.background = element_rect(fill = "lightgreen"),
panel.grid.major = element_line(colour = "grey50"),
panel.ontop = F,
panel.border = element_rect(linetype = "dashed", fill = "NA")
)




#geom_text(aes(y="count",label=issue), vjust = 0.5)
year_vote_plot
```


```{r}
library(showtext)
font_add_google("Roboto", "roboto")
font_add_google("Roboto Condensed", "roboto condensed")
font_add_google("Press Start 2P", "start2p")
font_add_google("Share Tech Mono", "techmono")
showtext_opts(dpi = 320)
showtext_auto(enable = FALSE)
```

library(stringr)

library(glue)
library(patchwork)
library(ggtext)

library(rnaturalearth)
library(sf)

library(geosphere)
library(maps)


```{r}
showtext_auto(enable = TRUE)
library(patchwork)
library(sf)
library(ggplot2)
library(rnaturalearth)


# inset_element(plot,left,bottom,right,top,align_to = "panel",on_top = TRUE,clip = TRUE,ignore_tag = FALSE)

final <- main_plot+
  
  
#inset_element(linechart,1,1,1,1) +
#inset_element(year_vote_plot,0.5,0.5,1,1) +

plot_layout(nrow = 1, widths = c(1, 2, 1)) &
theme(plot.margin = unit(c(.2,.2,.2,.2), "cm")) &
theme(plot.background = element_rect(color = 'blue', size = 2,linetype = 'dotted', fill ="ivory"))


plot_annotation(caption = "Visualization: Federica Gazzelloni | Data: UN Votes",

                theme = theme(

                  plot.margin = margin(10,10,10,10),

                  plot.background = element_rect(fill = bck_clr, color = NA),

                  plot.caption = element_text(family = NULL,

                                              size = 9, color = "white",

                                              margin = margin(15,0,0,0), hjust = 0.95)))


ragg::agg_png(here::here("render", paste0("UN_votes_",

                                          format(Sys.time(),"%Y%m%d_%H%M%S"),

                                          ".png")),

              res = 320, width = 14, height = 8, units = "in")
final


dev.off()
```




```{r}
p1<-main_plot
p2<-linechart
p3<-year_vote_plot




p3 + plot_spacer() + p2 + plot_spacer() + p1
```


```{r}
p1+p2 +p3+

  plot_layout(widths = c(2, 1))+

  plot.background = element_rect(fill = "#0b6ef7")
```


```{r}
library(ggpubr)
background_image("tt_hex.png")


```



```{r}
#install.packages("ggthemes") # Install
library(ggthemes) # Load
```




```{r}
p1+p2 +p3+
plot_layout(widths = c(2, 1))+
theme = theme(
plot.margin = margin(10,10,10,10),
plot.background = element_rect(fill = bck_clr, color = NA),
plot.caption = element_text(family = "techmono", size = 9, color = "white", margin = margin(15,0,0,0), hjust = 0.95)
)


theme_wsj()+ scale_colour_wsj("colors6")+
ggtitle("UN Votes (1946 - 2019)")
```



















